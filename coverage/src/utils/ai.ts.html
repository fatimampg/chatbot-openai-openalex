
<!doctype html>
<html lang="en">

<head>
    <title>Code coverage report for src/utils/ai.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <link rel="shortcut icon" type="image/x-icon" href="../../favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
    
<body>
<div class='wrapper'>
    <div class='pad1'>
        <h1><a href="../../index.html">All files</a> / <a href="index.html">src/utils</a> ai.ts</h1>
        <div class='clearfix'>
            
            <div class='fl pad1y space-right2'>
                <span class="strong">27.27% </span>
                <span class="quiet">Statements</span>
                <span class='fraction'>15/55</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">100% </span>
                <span class="quiet">Branches</span>
                <span class='fraction'>0/0</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">0% </span>
                <span class="quiet">Functions</span>
                <span class='fraction'>0/2</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">27.27% </span>
                <span class="quiet">Lines</span>
                <span class='fraction'>15/55</span>
            </div>
        
            
        </div>
        <p class="quiet">
            Press <em>n</em> or <em>j</em> to go to the next uncovered block, <em>b</em>, <em>p</em> or <em>k</em> for the previous block.
        </p>
        <template id="filterTemplate">
            <div class="quiet">
                Filter:
                <input type="search" id="fileSearch">
            </div>
        </template>
    </div>
    <div class='status-line low'></div>
    <pre><table class="coverage">
<tr><td class="line-count quiet"><a name='L1'></a><a href='#L1'>1</a>
<a name='L2'></a><a href='#L2'>2</a>
<a name='L3'></a><a href='#L3'>3</a>
<a name='L4'></a><a href='#L4'>4</a>
<a name='L5'></a><a href='#L5'>5</a>
<a name='L6'></a><a href='#L6'>6</a>
<a name='L7'></a><a href='#L7'>7</a>
<a name='L8'></a><a href='#L8'>8</a>
<a name='L9'></a><a href='#L9'>9</a>
<a name='L10'></a><a href='#L10'>10</a>
<a name='L11'></a><a href='#L11'>11</a>
<a name='L12'></a><a href='#L12'>12</a>
<a name='L13'></a><a href='#L13'>13</a>
<a name='L14'></a><a href='#L14'>14</a>
<a name='L15'></a><a href='#L15'>15</a>
<a name='L16'></a><a href='#L16'>16</a>
<a name='L17'></a><a href='#L17'>17</a>
<a name='L18'></a><a href='#L18'>18</a>
<a name='L19'></a><a href='#L19'>19</a>
<a name='L20'></a><a href='#L20'>20</a>
<a name='L21'></a><a href='#L21'>21</a>
<a name='L22'></a><a href='#L22'>22</a>
<a name='L23'></a><a href='#L23'>23</a>
<a name='L24'></a><a href='#L24'>24</a>
<a name='L25'></a><a href='#L25'>25</a>
<a name='L26'></a><a href='#L26'>26</a>
<a name='L27'></a><a href='#L27'>27</a>
<a name='L28'></a><a href='#L28'>28</a>
<a name='L29'></a><a href='#L29'>29</a>
<a name='L30'></a><a href='#L30'>30</a>
<a name='L31'></a><a href='#L31'>31</a>
<a name='L32'></a><a href='#L32'>32</a>
<a name='L33'></a><a href='#L33'>33</a>
<a name='L34'></a><a href='#L34'>34</a>
<a name='L35'></a><a href='#L35'>35</a>
<a name='L36'></a><a href='#L36'>36</a>
<a name='L37'></a><a href='#L37'>37</a>
<a name='L38'></a><a href='#L38'>38</a>
<a name='L39'></a><a href='#L39'>39</a>
<a name='L40'></a><a href='#L40'>40</a>
<a name='L41'></a><a href='#L41'>41</a>
<a name='L42'></a><a href='#L42'>42</a>
<a name='L43'></a><a href='#L43'>43</a>
<a name='L44'></a><a href='#L44'>44</a>
<a name='L45'></a><a href='#L45'>45</a>
<a name='L46'></a><a href='#L46'>46</a>
<a name='L47'></a><a href='#L47'>47</a>
<a name='L48'></a><a href='#L48'>48</a>
<a name='L49'></a><a href='#L49'>49</a>
<a name='L50'></a><a href='#L50'>50</a>
<a name='L51'></a><a href='#L51'>51</a>
<a name='L52'></a><a href='#L52'>52</a>
<a name='L53'></a><a href='#L53'>53</a>
<a name='L54'></a><a href='#L54'>54</a>
<a name='L55'></a><a href='#L55'>55</a>
<a name='L56'></a><a href='#L56'>56</a>
<a name='L57'></a><a href='#L57'>57</a>
<a name='L58'></a><a href='#L58'>58</a>
<a name='L59'></a><a href='#L59'>59</a>
<a name='L60'></a><a href='#L60'>60</a>
<a name='L61'></a><a href='#L61'>61</a>
<a name='L62'></a><a href='#L62'>62</a>
<a name='L63'></a><a href='#L63'>63</a>
<a name='L64'></a><a href='#L64'>64</a>
<a name='L65'></a><a href='#L65'>65</a>
<a name='L66'></a><a href='#L66'>66</a>
<a name='L67'></a><a href='#L67'>67</a>
<a name='L68'></a><a href='#L68'>68</a>
<a name='L69'></a><a href='#L69'>69</a>
<a name='L70'></a><a href='#L70'>70</a>
<a name='L71'></a><a href='#L71'>71</a>
<a name='L72'></a><a href='#L72'>72</a>
<a name='L73'></a><a href='#L73'>73</a>
<a name='L74'></a><a href='#L74'>74</a>
<a name='L75'></a><a href='#L75'>75</a>
<a name='L76'></a><a href='#L76'>76</a>
<a name='L77'></a><a href='#L77'>77</a>
<a name='L78'></a><a href='#L78'>78</a>
<a name='L79'></a><a href='#L79'>79</a>
<a name='L80'></a><a href='#L80'>80</a>
<a name='L81'></a><a href='#L81'>81</a>
<a name='L82'></a><a href='#L82'>82</a>
<a name='L83'></a><a href='#L83'>83</a>
<a name='L84'></a><a href='#L84'>84</a>
<a name='L85'></a><a href='#L85'>85</a>
<a name='L86'></a><a href='#L86'>86</a>
<a name='L87'></a><a href='#L87'>87</a>
<a name='L88'></a><a href='#L88'>88</a>
<a name='L89'></a><a href='#L89'>89</a>
<a name='L90'></a><a href='#L90'>90</a>
<a name='L91'></a><a href='#L91'>91</a></td><td class="line-coverage quiet"><span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import { ChatOpenAI } from "@langchain/openai";
import { StructuredOutputParser } from "langchain/output_parsers";
import { PromptTemplate } from "@langchain/core/prompts";
import z from "zod";
import { Message } from "../types/types";
&nbsp;
const parser = StructuredOutputParser.fromZodSchema(
  z.object({
    comments: z.string().describe(
      `You are an agent that will respond to users questions. Answer those questions and if user asks for help finding research publications, based on specific criteria such as search terms (theme/topic), number of citations, year or open access, then you should generate a query string according to the following instructions. Respond naturally and acknowledge it in your own words. 
      - If the users requests for publications BUT criteria are unclear and/or a search term appears to be a random combination of letters or doesn’t contain recognizable words: Respond by saying that the term doesn’t seem to match any known topic and ask the user to clarify or provide a more specific keyword.
      - If no criteria are provided: Offer to find publications on any topic, and show results based on publication year, number of citations or open-access.,
      - If search terms and criteria are clear: Tell the user that you'll present a list of publicashions matching those criteria. Use your own words!`,
    ),
    query: z.string().describe(
      `Generate query strings based on these criteria from user's message:
            1) **Publication Year**: could be a single or range of years.
                - Single year: "publication_year:{YEAR}" 
                (where {YEAR} is the specific year).
                - Range: "publication_year:%3E{YEAR_START},publication_year:%3C{YEAR_END}"
                (where {YEAR_START} and {YEAR_END} are the start and end years).
                - After: "publication_year:%3E{YEAR_L}"
                (where {YEAR_L} is the start year).
                - Before: "publication_year:%3C{YEAR_H}"
                (where {YEAR_H} is the start year).
            2) **Citations Count**: could be a single value or a range of values.
                - Single value: "cited_by_count:{NUMBER}"
                (where {NUMBER} is the specified citation count).
                - Range: "cited_by_count:%3E{LOW_CITATION_NUMBER},cited_by_count:%3C{HIGH_CITATION_NUMBER}"
                (where {LOW_CITATION_NUMBER} and {HIGH_CITATION_NUMBER} are the lower and upper bounds.
                - More than: "cited_by_count:%3E{CITATION_NUMBER_L}"
                (where {CITATION_NUMBER_L} is the minimum number of citations).
                - Less than: "cited_by_count:%3C{CITATION_NUMBER_H}"
                (where {CITATION_NUMBER_H} is the maximum number of citations).
            3) **Open Access**: "is_oa:true"
            4) **Search Terms**: "default.search:{CONCATENATED_MAIN_SEARCH_TERMS}"
                (where {CONCATENATED_MAIN_SEARCH_TERMS} is the string of main search terms concatenated using plus signs (+) to replace spaces).
            If more than one criterion is met, generate separate strings for each criterion and concatenate them using comma (,). The default.search related query must allways be present!. If no criteria are provided or are unclear, return empty query string (""). Add the strings allways in the same order (order of related strings (add the ones identified): Publication Year, Citations Count, Open Access, Search Terms): !`,
    ),
  }),
);
&nbsp;
const getPrompt = <span class="fstat-no" title="function not covered" >async (messages: Message[]) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >  const formattedMessages = messages.map(</span>
<span class="cstat-no" title="statement not covered" >    (message) =&gt;</span>
<span class="cstat-no" title="statement not covered" >      `${message.role}: ${message.content} ${message.role === "ai" &amp;&amp; message.publications &amp;&amp; message.publications.length &gt; 0 ? ` --&gt; ${JSON.stringify(message.publications)}` : ""}`,</span>
  );
&nbsp;
<span class="cstat-no" title="statement not covered" >  const format_instructions = parser.getFormatInstructions();</span>
<span class="cstat-no" title="statement not covered" >  const prompt = new PromptTemplate({</span>
<span class="cstat-no" title="statement not covered" >    template: `Analyse the following conversation (messages given by you and by the user, are identified with "role: ai" and "role: user", respectively) and respond to the last user message. Respond naturally and be accurate. Follow the instructions given and ensure that your response follows the required format strictly, no matter what! If user ask for publications (indicate search terms and other criteria), do not search or check for publications that include the provided search terms and criteria defined by the user! Concerning publications, your goal is to translate users' requirements and generate a query string following the instructions. \n {format_instructions} \n {conversation}`,</span>
<span class="cstat-no" title="statement not covered" >    inputVariables: ["conversation"],</span>
<span class="cstat-no" title="statement not covered" >    partialVariables: { format_instructions },</span>
<span class="cstat-no" title="statement not covered" >  });</span>
<span class="cstat-no" title="statement not covered" >  const input = await prompt.format({</span>
<span class="cstat-no" title="statement not covered" >    conversation: formattedMessages,</span>
<span class="cstat-no" title="statement not covered" >  });</span>
<span class="cstat-no" title="statement not covered" >  console.log("Received message - from OPENAI:", input);</span>
<span class="cstat-no" title="statement not covered" >  return input;</span>
<span class="cstat-no" title="statement not covered" >};</span>
&nbsp;
export const analyse = <span class="fstat-no" title="function not covered" >async (chatHistory: Message[]) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >  const input = await getPrompt(chatHistory);</span>
<span class="cstat-no" title="statement not covered" >  const apiKey = import.meta.env.VITE_OPENAI_API_KEY;</span>
<span class="cstat-no" title="statement not covered" >  const model = new ChatOpenAI({</span>
<span class="cstat-no" title="statement not covered" >    apiKey,</span>
<span class="cstat-no" title="statement not covered" >    temperature: 0,</span>
<span class="cstat-no" title="statement not covered" >    model: "gpt-4o-mini",</span>
<span class="cstat-no" title="statement not covered" >  });</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  try {</span>
<span class="cstat-no" title="statement not covered" >    const result = await model.invoke(input);</span>
<span class="cstat-no" title="statement not covered" >    const rawContent = String(result.content);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    const contentString = rawContent.replace(/```json\n|```/g, "").trim();</span>
<span class="cstat-no" title="statement not covered" >    const content = JSON.parse(contentString);</span>
<span class="cstat-no" title="statement not covered" >    const comments = content.comments;</span>
<span class="cstat-no" title="statement not covered" >    const query = content.query;</span>
<span class="cstat-no" title="statement not covered" >    console.log(query, "Query string generated by GPT-4");</span>
<span class="cstat-no" title="statement not covered" >    let url = "";</span>
<span class="cstat-no" title="statement not covered" >    if (query) {</span>
<span class="cstat-no" title="statement not covered" >      url = `https://api.openalex.org/works?filter=${query}&amp;select=id,relevance_score,title,type,primary_location,publication_year,authorships,doi,open_access,abstract_inverted_index,cited_by_count&amp;sort=relevance_score:desc`;</span>
<span class="cstat-no" title="statement not covered" >    }</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    return { comments, url };</span>
<span class="cstat-no" title="statement not covered" >  } catch (error) {</span>
<span class="cstat-no" title="statement not covered" >    console.log(error);</span>
<span class="cstat-no" title="statement not covered" >    console.error(`Error while requesting to OpenAI API: ${error}`);</span>
<span class="cstat-no" title="statement not covered" >  }</span>
<span class="cstat-no" title="statement not covered" >};</span>
&nbsp;</pre></td></tr></table></pre>

                <div class='push'></div><!-- for sticky footer -->
            </div><!-- /wrapper -->
            <div class='footer quiet pad2 space-top1 center small'>
                Code coverage generated by
                <a href="https://istanbul.js.org/" target="_blank" rel="noopener noreferrer">istanbul</a>
                at 2024-11-01T13:02:49.904Z
            </div>
        <script src="../../prettify.js"></script>
        <script>
            window.onload = function () {
                prettyPrint();
            };
        </script>
        <script src="../../sorter.js"></script>
        <script src="../../block-navigation.js"></script>
    </body>
</html>
    